<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Data Sensor</title>
    <link rel="stylesheet" th:href="@{/css/data_sensor.css}">
</head>
<body>
    <!-- Header fragment -->
    <div th:replace="fragments/header :: header"></div>

    <div class="container">
        <h2 style="margin: 5px">Data Sensor</h2>

        <form id="filterForm" class="filter-bar" method="get" th:action="@{/data_sensor}">
            <input type="hidden" id="pageInput" name="page" th:value="${page}" />
            <select id="roomSelect" name="room" th:value="${room}">
                <option value="room1">Room</option>
                <option value="room1" th:selected="${room == 'room1'}">Room 1</option>
                <option value="room2" th:selected="${room == 'room2'}">Room 2</option>
                <option value="room3" th:selected="${room == 'room3'}">Room 3</option>
            </select>
            <!-- Nút Sensor -->
            <div class="dropdown">
                <button type="button" id="sensorDropdownBtn" class="dropdown-btn">Advanced ▼</button>
                <div id="sensorDropdown" class="sensor-dropdown-container" style="display:none;">
                    <div class="sensor-threshold-container">

                        <!--humidity-->
                        <div class="sensor-row">
                            <label>
                                <input type="checkbox" class="sensor-checkbox"
                                       name="sensors"
                                       value="humidity"
                                       th:checked="${filter.sensors != null and filter.sensors.contains('humidity')}">
                                <span class="sensor-label">
                                    <span class="sensor-icon" style="background:#4b6fe7"></span>
                                    Độ ẩm
                                </span>
                            </label>
                            <select class="threshold-operator" name="thresholdOps[humidity]" disabled>
                                <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['humidity'] == null}">chọn ngưỡng</option>
                                <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['humidity'] == 'Equal'}">Equal</option>
                                <option value="Grater than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['humidity'] == 'Grater than'}">Grater than</option>
                                <option value="Less than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['humidity'] == 'Less than'}">Less than</option>
                                <option value="Range" th:selected="${filter.thresholdOps != null and filter.thresholdOps['humidity'] == 'Range'}">Range</option>
                            </select>
                <!-- server-rendered threshold value input so value persists after submit -->
                <input type="text" class="threshold-value"
                    name="thresholdValues[humidity]"
                    th:value="${filter.thresholdValues != null ? filter.thresholdValues['humidity'] : ''}"
                    th:disabled="${filter.sensors == null or !filter.sensors.contains('humidity')}"
                    placeholder="Giá trị" style="margin-left:8px;" />
                        </div>

                        <!--light-->
                        <div class="sensor-row">
                            <label>
                                <input type="checkbox" class="sensor-checkbox"
                                       name="sensors"
                                       value="light_Level"
                                       th:checked="${filter.sensors != null and filter.sensors.contains('light_Level')}">
                                <span class="sensor-label">
                                    <span class="sensor-icon" style="background:#4b6fe7"></span>
                                    Ánh sáng
                                </span>
                            </label>
                            <select class="threshold-operator" name="thresholdOps[light_Level]" disabled>
                                <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['light_Level'] == null}">chọn ngưỡng</option>
                                <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['light_Level'] == 'Equal'}">Equal</option>
                                <option value="Grater than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['light_Level'] == 'Grater than'}">Grater than</option>
                                <option value="Less than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['light_Level'] == 'Less than'}">Less than</option>
                                <option value="Range" th:selected="${filter.thresholdOps != null and filter.thresholdOps['light_Level'] == 'Range'}">Range</option>
                            </select>
                <!-- server-rendered threshold value input so value persists after submit -->
                <input type="text" class="threshold-value"
                    name="thresholdValues[light_Level]"
                    th:value="${filter.thresholdValues != null ? filter.thresholdValues['light_Level'] : ''}"
                    th:disabled="${filter.sensors == null or !filter.sensors.contains('light_Level')}"
                    placeholder="Giá trị" style="margin-left:8px;" />
                        </div>

<!--                        temp-->
                        <div class="sensor-row">
                            <label>
                                <input type="checkbox" class="sensor-checkbox"
                                       name="sensors"
                                       value="temperature"
                                       th:checked="${filter.sensors != null and filter.sensors.contains('temperature')}">
                                <span class="sensor-label">
                                    <span class="sensor-icon" style="background:#4b6fe7"></span>
                                    Nhiệt độ
                                </span>
                            </label>
                            <select class="threshold-operator" name="thresholdOps[temperature]" disabled>
                                <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['temperature'] == null}">chọn ngưỡng</option>
                                <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['temperature'] == 'Equal'}">Equal</option>
                                <option value="Grater than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['temperature'] == 'Grater than'}">Grater than</option>
                                <option value="Less than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['temperature'] == 'Less than'}">Less than</option>
                                <option value="Range" th:selected="${filter.thresholdOps != null and filter.thresholdOps['temperature'] == 'Range'}">Range</option>
                            </select>
                <!-- server-rendered threshold value input so value persists after submit -->
                <input type="text" class="threshold-value"
                    name="thresholdValues[temperature]"
                    th:value="${filter.thresholdValues != null ? filter.thresholdValues['temperature'] : ''}"
                    th:disabled="${filter.sensors == null or !filter.sensors.contains('temperature')}"
                    placeholder="Giá trị" style="margin-left:8px;" />
                        </div>

<!--                        time-->
                        <div class="sensor-row">
                            <label>
                                <input type="checkbox" class="sensor-checkbox"
                                       name="sensors"
                                       value="timestamp"
                                       th:checked="${filter.sensors != null and filter.sensors.contains('timestamp')}">
                                <span class="sensor-label">
                                    <span class="sensor-icon" style="background:#4b6fe7"></span>
                                    Thời gian
                                </span>
                            </label>
                            <select class="threshold-operator" name="thresholdOps[timestamp]" disabled>
                            <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['timestamp'] == null}">chọn ngưỡng</option>
                            <option value="Equal" th:selected="${filter.thresholdOps != null and filter.thresholdOps['timestamp'] == 'Equal'}">Equal</option>
                            <option value="Grater than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['timestamp'] == 'Grater than'}">Grater than</option>
                            <option value="Less than" th:selected="${filter.thresholdOps != null and filter.thresholdOps['timestamp'] == 'Less than'}">Less than</option>
                            <option value="Range" th:selected="${filter.thresholdOps != null and filter.thresholdOps['timestamp'] == 'Range'}">Range</option>
                            </select>
                <!-- server-rendered threshold value input so value persists after submit -->
                <input type="text" class="threshold-value"
                    name="thresholdValues[timestamp]"
                    th:value="${filter.thresholdValues != null ? filter.thresholdValues['timestamp'] : ''}"
                    th:disabled="${filter.sensors == null or !filter.sensors.contains('timestamp')}"
                    placeholder="Giá trị" style="margin-left:8px;" />
                        </div>


                    </div>
                    <div style="margin-top:8px; text-align:right;">
                        <button type="button" id="advancedResetBtn" class="advanced-reset-btn">Reset</button>
                    </div>
                    <div id="rangeHint" style="display:none;color:#666;font-size:0.9em;margin-top:6px;">";" vào giữa</div>
                </div>
            </div>

            <div class="input-group">
                <input type="text" id="searchInput" name="inputSearch" placeholder="Nhập thông tin cần tìm" th:value="${filter.getInputSearch()}">
                <div id="inputGuide" class="input-guide"></div>
            </div>
            <button id="searchBtn" type="submit">Search</button>
        </form>


        <div class="table-responsive">
            <table id="sensorTable">
                <thead>
                    <tr>
                                <th>ID</th>
                                <th>Temperature</th>
                                <th>Humidity</th>
                                <th>Light</th>
                                <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="sensor : ${dataSensorEntities}">
                        <td th:text="${sensor.id}"></td>
                        <td th:text="${sensor.temperature}"></td>
                        <td th:text="${sensor.humidity}"></td>
                        <td th:text="${sensor.lightLevel}"></td>
                        <td th:text="${#temporals.format(sensor.timestamp, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(dataSensorEntities)}">
                        <td colspan="5" style="text-align:center;">Không có dữ liệu</td>
                    </tr>
                </tbody>
            </table>
        </div>
       <div class="table-footer">
            <div class="pagination fixed-area">
                <button type="button" id="prevBtn" th:disabled="${page == 0}">&lt;</button>
                <span th:if="${totalPages <= 5}">
                    <button th:each="i : ${#numbers.sequence(1, totalPages)}"
                            th:classappend="${i == page + 1} ? ' active' : ''"
                            th:text="${i}"
                            th:attr="data-page=${i - 1}"></button>
                </span>
                <span th:if="${totalPages > 5}">
                    <button type="button" id="pageBtn1" data-page="0">1</button>
                    <button type="button" id="pageBtn2" data-page="1">2</button>
                    <input id="pageJumpInput" type="number" min="1" th:attr="max=${totalPages}" placeholder="" style="width:50px;" />
                    <button id="pageJumpBtn" type="button">Go</button>
                    <button type="button" th:classappend="${(totalPages - 1) == page + 1} ? ' active' : ''"
                            th:text="${totalPages - 1}"
                            th:attr="data-page=${totalPages - 2}"></button>
                    <button type="button" th:classappend="${totalPages == page + 1} ? ' active' : ''"
                            th:text="${totalPages}"
                            th:attr="data-page=${totalPages - 1}"></button>
                </span>
                <button type="button" id="nextBtn" th:disabled="${page + 1 == totalPages}">&gt;</button>
            </div>
            <div class="fixed-area">
                <div class="row-count">
                    Số dòng hiển thị
                    <select id="rowCountSelect" name="size" th:value="${size}">
                        <option th:selected="${size == 10}" th:value="10">10</option>
                        <option th:selected="${size == 20}" th:value="20">20</option>
                        <option th:selected="${size == 30}" th:value="30">30</option>
                    </select>
                </div>
            </div>
        </div>
    </div>



    <script>
        // --- Threshold dropdown & value inputs (existing logic) ---
        // Hiện/ẩn dropdown khi click nút
        (function(){
            const btn = document.getElementById('sensorDropdownBtn');
            const dropdown = document.getElementById('sensorDropdown');
            const form = document.querySelector('form.filter-bar');
            const searchBtn = document.getElementById('searchBtn');
            const advancedErrorId = 'advancedErrorMsg';

            function ensureErrorNode(){
                let n = document.getElementById(advancedErrorId);
                if(!n){
                    n = document.createElement('div');
                    n.id = advancedErrorId;
                    n.style.color = 'red';
                    n.style.margin = '8px 0';
                    n.style.fontSize = '0.9em';
                    // Insert the error node right after the filter form so it appears under the search filters
                    if(form && form.parentNode){
                        form.parentNode.insertBefore(n, form.nextSibling);
                    } else if(dropdown && dropdown.parentNode){
                        // fallback to previous location
                        dropdown.parentNode.insertBefore(n, dropdown.nextSibling);
                    }
                }
                return n;
            }

            function isAdvancedValid(){
                // For each checked sensor require operator selected (not placeholder text 'chọn ngưỡng') and a non-empty value
                let valid = true;
                document.querySelectorAll('.sensor-row').forEach(function(row){
                    const checkbox = row.querySelector('.sensor-checkbox');
                    if(!checkbox) return;
                    if(checkbox.checked){
                        const select = row.querySelector('.threshold-operator');
                        const valueInput = row.querySelector('.threshold-value');
                        // operator: ensure selected option text isn't the placeholder 'chọn ngưỡng'
                        let opOk = true;
                        if(select){
                            const txt = (select.selectedOptions && select.selectedOptions[0]) ? select.selectedOptions[0].textContent.trim().toLowerCase() : '';
                            if(txt === 'chọn ngưỡng' || txt === '') opOk = false;
                        }
                        const valOk = valueInput && valueInput.value && valueInput.value.trim().length > 0;
                        if(!opOk || !valOk) valid = false;
                    }
                });
                return valid;
            }

            function updateAdvancedValidity(showIfInvalid){
                // showIfInvalid: when true, display the warning if invalid; when false, just clear warning if now valid
                const errorNode = document.getElementById(advancedErrorId);
                if(isAdvancedValid()){
                    if(errorNode) errorNode.textContent = '';
                    return true;
                }
                if(showIfInvalid){
                    const n = ensureErrorNode();
                    n.textContent = 'Vui lòng chọn ngưỡng và nhập giá trị cho tất cả sensor đã chọn trước khi tắt Advanced hoặc tìm kiếm.';
                }
                return false;
            }

            // Ẩn dropdown khi click ra ngoài (allow closing even if invalid)
            document.addEventListener('click', function(e) {
                if(!dropdown) return;
                if(dropdown.style.display === 'block'){
                    dropdown.style.display = 'none';
                }
            });

            // Không ẩn khi click bên trong dropdown
            document.getElementById('sensorDropdown').addEventListener('click', function(e) {
                e.stopPropagation();
            });

            // Toggle button: simply toggle (allow closing even if invalid)
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                if(!dropdown) return;
                dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
            });

            // Bật/tắt ô chọn ngưỡng khi tick sensor
            function updateThresholdSelects() {
                document.querySelectorAll('.sensor-row').forEach(function(row) {
                    const checkbox = row.querySelector('.sensor-checkbox');
                    const select = row.querySelector('.threshold-operator');
                    if (checkbox && select) {
                        if(checkbox.checked){
                            // ensure the select is interactive. Some server-rendered disabled attributes or CSS
                            // can prevent interaction; to be defensive recreate the select element without disabled.
                            let actualSelect = select;
                            try{
                                const isDisabledAttr = select.hasAttribute && select.hasAttribute('disabled');
                                if(isDisabledAttr || select.disabled){
                                    // build a new select copying options, but without disabled attribute
                                    const newSelect = document.createElement('select');
                                    newSelect.className = select.className || '';
                                    if(select.getAttribute('name')) newSelect.setAttribute('name', select.getAttribute('name'));
                                    // copy options
                                    for(let i=0;i<select.options.length;i++){
                                        const opt = select.options[i];
                                        const o = document.createElement('option');
                                        o.value = opt.value;
                                        o.textContent = opt.textContent;
                                        if(opt.selected) o.selected = true;
                                        newSelect.appendChild(o);
                                    }
                                    // replace in DOM
                                    select.parentNode.replaceChild(newSelect, select);
                                    actualSelect = newSelect;
                                }
                            }catch(e){ actualSelect = select; }

                            // ensure enabled and interactive
                            try{ actualSelect.disabled = false; actualSelect.removeAttribute && actualSelect.removeAttribute('disabled'); }catch(e){}
                            actualSelect.tabIndex = 0; actualSelect.style.pointerEvents = 'auto'; actualSelect.style.display = '';

                            // Attach change listener to newly created selects so placeholder updates when operator changes
                            try{
                                actualSelect.addEventListener('change', function(){
                                    if(document.getElementById(advancedErrorId) && isAdvancedValid()) updateAdvancedValidity(false);
                                    updateValuePlaceholders();
                                });
                            }catch(e){}

                            // ensure value input exists and is interactive
                            let valueInput = row.querySelector('.threshold-value');
                            if(!valueInput){
                                const selName = actualSelect.getAttribute('name') || '';
                                let key = selName.replace(/.*\[(.*)\].*/, '$1');
                                if(!key || key === selName) key = '';
                                valueInput = document.createElement('input');
                                valueInput.type = 'text';
                                valueInput.className = 'threshold-value';
                                valueInput.name = key ? ('thresholdValues[' + key + ']') : 'thresholdValues[]';
                                valueInput.placeholder = 'Giá trị';
                                valueInput.style.marginLeft = '8px';
                                actualSelect.parentNode.insertBefore(valueInput, actualSelect.nextSibling);
                                // attach input listener to newly created input to clear errors and update placeholders
                                try{ valueInput.addEventListener('input', function(){ if(document.getElementById(advancedErrorId) && isAdvancedValid()) updateAdvancedValidity(false); updateValuePlaceholders(); }); }catch(e){}
                            }
                            try{ valueInput.disabled = false; valueInput.removeAttribute && valueInput.removeAttribute('disabled'); }catch(e){}
                            valueInput.tabIndex = 0; valueInput.style.pointerEvents = 'auto'; valueInput.style.display = '';

                            // attach listener (if any)
                            try{ setTimeout(()=>{ actualSelect.focus(); }, 10); }catch(e){}
                            // Ensure placeholder reflects current operator immediately when enabling
                            try{ updateValuePlaceholders(); }catch(e){}

                        } else {
                            // when unchecked, keep operator/value visible but disabled (so UI stays consistent)
                            select.disabled = true;
                            select.style.display = '';
                            select.removeAttribute('aria-required');
                            select.removeAttribute('aria-hidden');
                            const valueInput = row.querySelector('.threshold-value');
                            if(valueInput){
                                // clear value and disable but keep visible
                                valueInput.value = '';
                                valueInput.disabled = true;
                                valueInput.style.display = '';
                                valueInput.removeAttribute('aria-required');
                                // placeholder left as default when disabled
                            }
                        }
                    }
                });
                // After processing all rows, refresh placeholders to reflect any changes
                try{ updateValuePlaceholders(); }catch(e){}
                // do not show warnings now; validation happens on Search submit
                // but clear any existing error if the user fixed inputs
                if(document.getElementById(advancedErrorId) && isAdvancedValid()){
                    updateAdvancedValidity(false);
                }
            }

            // Gọi khi trang load xong
            document.addEventListener('DOMContentLoaded', function() {
                // Khởi tạo trạng thái ban đầu
                updateThresholdSelects();

                // Lắng nghe sự kiện thay đổi checkbox
                document.querySelectorAll('.sensor-checkbox').forEach(function(checkbox) {
                    checkbox.addEventListener('change', updateThresholdSelects);
                });

                // listen for changes on selects/inputs inside advanced to clear warning if fixed
                document.querySelectorAll('.sensor-row').forEach(function(row){
                    const select = row.querySelector('.threshold-operator');
                    const valueInput = row.querySelector('.threshold-value');
                    if(select) select.addEventListener('change', function(){ if(document.getElementById(advancedErrorId) && isAdvancedValid()) updateAdvancedValidity(false); updateValuePlaceholders(); });
                    if(valueInput) valueInput.addEventListener('input', function(){ if(document.getElementById(advancedErrorId) && isAdvancedValid()) updateAdvancedValidity(false); });
                });

                // advanced reset button behaviour
                const resetBtn = document.getElementById('advancedResetBtn');
                if(resetBtn){
                    resetBtn.addEventListener('click', function(){
                        // uncheck all, clear selects and values
                        document.querySelectorAll('.sensor-row').forEach(function(row){
                            const checkbox = row.querySelector('.sensor-checkbox');
                            const select = row.querySelector('.threshold-operator');
                            const valueInput = row.querySelector('.threshold-value');
                            if(checkbox){ checkbox.checked = false; }
                            if(select){
                                select.selectedIndex = 0; // back to placeholder
                                select.disabled = true;
                                // keep visible but disabled
                                select.style.display = '';
                                select.removeAttribute('aria-required');
                                // placeholder left as default
                            }
                            if(valueInput){
                                valueInput.value = '';
                                valueInput.disabled = true;
                                // keep visible but disabled
                                valueInput.style.display = '';
                                valueInput.removeAttribute('aria-required');
                            }
                        });
                        // clear any error message
                        const err = document.getElementById(advancedErrorId); if(err) err.textContent = '';
                        // update placeholders after reset
                        updateValuePlaceholders();
                    });
                }

                // (placeholder helper removed) keep default placeholders

                // If the page was loaded without any filter/search params, ensure Advanced controls are empty
                try{
                    const params = new URLSearchParams(window.location.search);
                    const hasAnyFilter = params.has('sensors') || params.has('thresholdValues') || params.has('thresholdOps') || params.has('inputSearch') || params.has('room') || params.has('size') || params.has('page');
                    if(!hasAnyFilter){
                        // clear advanced UI to default empty state (controls visible but disabled)
                        document.querySelectorAll('.sensor-row').forEach(function(row){
                            const checkbox = row.querySelector('.sensor-checkbox');
                            const select = row.querySelector('.threshold-operator');
                            let valueInput = row.querySelector('.threshold-value');
                            if(checkbox) checkbox.checked = false;
                            if(select){ select.selectedIndex = 0; select.disabled = true; select.style.display = ''; }
                            if(valueInput){ valueInput.value = ''; valueInput.disabled = true; valueInput.style.display = ''; }
                        });
                        // clear any previous error
                        const err = document.getElementById(advancedErrorId); if(err) err.textContent = '';
                    }
                }catch(e){ /* ignore in older browsers */ }
                // initial range placeholder state
                updateValuePlaceholders();
                function updateValuePlaceholders(){
                    try{
                        const rows = document.querySelectorAll('.sensor-row');
                        rows.forEach(function(row){
                            const select = row.querySelector('.threshold-operator');
                            let input = row.querySelector('.threshold-value');
                            if(!input) return;
                            // Check both the option text and the select value for robustness
                            const optText = (select && select.selectedOptions && select.selectedOptions[0]) ? select.selectedOptions[0].textContent.trim().toLowerCase() : '';
                            const optVal = (select && select.value) ? select.value.trim().toLowerCase() : '';
                            if(optText === 'range' || optVal === 'range'){
                                input.placeholder = '";" vào giữa';
                            } else {
                                input.placeholder = 'Giá trị';
                            }
                            // also ensure enabled state if checkbox is checked
                            const checkbox = row.querySelector('.sensor-checkbox');
                            if(checkbox && checkbox.checked){
                                try{ input.disabled = false; input.removeAttribute && input.removeAttribute('disabled'); }catch(e){}
                            }
                        });
                    }catch(e){/* ignore */}
                }
            });

            // Before submit, re-enable selected threshold controls so Spring binds them
            form.addEventListener('submit', function(e) {
                // final validation: if invalid and any sensor checked, block submit and show warning
                const anyChecked = Array.from(document.querySelectorAll('.sensor-checkbox')).some(cb => cb.checked);
                if(anyChecked && !isAdvancedValid()){
                    e.preventDefault();
                    // Close the advanced dropdown and show the warning under the filters
                    if(dropdown) dropdown.style.display = 'none';
                    updateAdvancedValidity(true);
                    return false;
                }

                document.querySelectorAll('.sensor-row').forEach(function(row) {
                    const checkbox = row.querySelector('.sensor-checkbox');
                    const select = row.querySelector('.threshold-operator');
                    if (checkbox && select && checkbox.checked) {
                        select.disabled = false;
                        const valueInput = row.querySelector('.threshold-value');
                        if(valueInput) valueInput.disabled = false;
                    }
                });
            });
        })();

    </script>
    <script>
            // sorting feature removed - template restored to original behavior
    </script>
    <!-- data_sensor: SSE removed per user request; page will not receive live updates -->
    <script>
        (function(){
            const form = document.getElementById('filterForm');
            const roomSelect = document.getElementById('roomSelect');
            const sensorSelect = document.getElementById('sensorSelect');
            const statusSelect = document.getElementById('statusSelect');
            const rowCountSelect = document.getElementById('rowCountSelect');
            const searchInput = document.getElementById('searchInput');

            function submitWithResetPage(){
                // ensure page parameter resets to 0 when filters change
                const url = new URL(window.location.href);
                url.searchParams.set('page', '0');
                // copy current form params into url
                const formData = new FormData(form);
                for(const [k,v] of formData.entries()){
                    url.searchParams.set(k, v);
                }
                window.location.href = url.toString();
            }

            // synchronize the selected row count into the form as input[name="size"] so it's always submitted
            function syncSizeToForm(){
                const row = document.getElementById('rowCountSelect');
                const f = document.getElementById('filterForm');
                if(!f || !row) return;
                let sizeInput = f.querySelector('input[name="size"]');
                if(!sizeInput){
                    sizeInput = document.createElement('input');
                    sizeInput.type = 'hidden';
                    sizeInput.name = 'size';
                    f.appendChild(sizeInput);
                }
                sizeInput.value = row.value;
            }
            // expose to global so other script blocks can use it
            window.syncSizeToForm = syncSizeToForm;

            // Do NOT auto-submit when selects change. Submit only when user clicks Search or presses Enter.
            // If you want to submit on select change in future, uncomment the block below.
            // [roomSelect, sensorSelect, statusSelect, rowCountSelect].forEach(el => {
            //     if(!el) return;
            //     el.addEventListener('change', function(){
            //         submitWithResetPage();
            //     });
            // });

            // Submit on Enter key in search input
            if(searchInput){
                searchInput.addEventListener('keydown', function(e){
                    if(e.key === 'Enter'){
                        e.preventDefault();
                        submitWithResetPage();
                    }
                });
            }

            // Ensure clicking the Search button resets page to 0 before submit
            const searchBtn = document.getElementById('searchBtn');
            const pageInput = document.getElementById('pageInput');
            if(searchBtn && pageInput){
                searchBtn.addEventListener('click', function(){
                    pageInput.value = 0;
                    syncSizeToForm();
                });
            }
        })();
        </script>
    <script>
        (function(){
            const form = document.getElementById('filterForm');
            const pageInput = document.getElementById('pageInput');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageJumpInput = document.getElementById('pageJumpInput');
            const pageJumpBtn = document.getElementById('pageJumpBtn');

            function goToPage(p){
                if(!form || pageInput == null) return;
                pageInput.value = p;
                if(typeof window.syncSizeToForm === 'function') window.syncSizeToForm();
                form.submit();
            }

            // page buttons (data-page attribute)
            document.querySelectorAll('.pagination button[data-page]').forEach(btn => {
                btn.addEventListener('click', function(e){
                    e.preventDefault();
                    e.stopPropagation();
                    const pRaw = this.getAttribute('data-page');
                    const p = Number(pRaw);
                    if(isNaN(p)) return;

                    // determine the last page index from the data-page attributes present
                    const pageButtons = Array.from(document.querySelectorAll('.pagination button[data-page]'))
                        .map(b => Number(b.getAttribute('data-page')))
                        .filter(n => !isNaN(n));
                    const last = pageButtons.length ? Math.max(...pageButtons) : null;

                    // helper to force left two to 1 and 2, using setButton to apply active class
                    function forceLeftToOneTwo(activePage){
                        const left1 = document.getElementById('pageBtn1');
                        const left2 = document.getElementById('pageBtn2');
                        if(typeof window.setButton === 'function'){
                            if(left1) window.setButton(left1, 0, activePage);
                            if(left2) window.setButton(left2, 1, activePage);
                        } else {
                            // fallback: direct DOM update
                            const pageInputVal = Number(pageInput.value || '0');
                            if(left1){ left1.textContent = '1'; left1.setAttribute('data-page', 0); left1.classList.toggle('active', pageInputVal === 0); }
                            if(left2){ left2.textContent = '2'; left2.setAttribute('data-page', 1); left2.classList.toggle('active', pageInputVal === 1); }
                        }
                    }

                    // If clicked page is one of the last two pages, force left buttons to 1 and 2
                    if(last !== null && p >= last - 1){
                        forceLeftToOneTwo(p);
                    } else {
                        // otherwise maintain the sliding behaviour
                        if(window.updateFirstTwoButtons){
                            try{ window.updateFirstTwoButtons(p); }catch(e){ /* ignore */ }
                        }
                    }

                    goToPage(p);
                });
            });

            if(prevBtn){
                prevBtn.addEventListener('click', function(){
                    const cur = parseInt(pageInput.value || '0', 10);
                    if(cur > 0) goToPage(cur - 1);
                });
            }
            if(nextBtn){
                nextBtn.addEventListener('click', function(){
                    const cur = parseInt(pageInput.value || '0', 10);
                    goToPage(cur + 1);
                });
            }

            if(pageJumpBtn && pageJumpInput){
                pageJumpBtn.addEventListener('click', function(){
                    const v = parseInt(pageJumpInput.value, 10);
                    if(!isNaN(v)){
                        // convert 1-based user input to 0-based page index
                        // before navigating, update first two buttons according to rule
                        updateFirstTwoButtons(v - 1);
                        goToPage(v - 1);
                    }
                });
                pageJumpInput.addEventListener('keydown', function(e){
                    if(e.key === 'Enter'){
                        e.preventDefault();
                        pageJumpBtn.click();
                    }
                });
            }
        })();
        // submit when row count changes (reset to first page)
        (function(){
            const rowCount = document.getElementById('rowCountSelect');
            const pageInput = document.getElementById('pageInput');
            const form = document.getElementById('filterForm');
            if(rowCount && form && pageInput){
                // ensure the form contains an input named 'size' so its value is submitted
                function ensureSizeInput(){
                    let sizeInput = form.querySelector('input[name="size"]');
                    if(!sizeInput){
                        sizeInput = document.createElement('input');
                        sizeInput.type = 'hidden';
                        sizeInput.name = 'size';
                        form.appendChild(sizeInput);
                    }
                    sizeInput.value = rowCount.value;
                }

                // initialize hidden input on load
                ensureSizeInput();

                rowCount.addEventListener('change', function(){
                    // reset to first page
                    pageInput.value = 0;
                    // update/ensure size hidden input so it's sent with the form
                    ensureSizeInput();
                    form.submit();
                });
            }
        })();
    </script>
    <script th:inline="javascript">
        // pagination helpers: set the first two buttons so that button2 shows current page
        (function(){
            const pageInput = document.getElementById('pageInput');
            const totalPages = /*[[${totalPages}]]*/ 0; // Thymeleaf will replace
            const pageBtn1 = document.getElementById('pageBtn1');
            const pageBtn2 = document.getElementById('pageBtn2');

            function setButton(btn, pageZeroBased, activePage){
                if(!btn) return;
                const display = pageZeroBased + 1;
                btn.textContent = display;
                btn.setAttribute('data-page', pageZeroBased);
                const active = (typeof activePage === 'number') ? activePage : parseInt(pageInput.value||'0',10);
                btn.classList.toggle('active', active === pageZeroBased);
            }

            // expose for other script blocks
            window.setButton = setButton;

            window.updateFirstTwoButtons = function(currentZeroBased){
                if(!pageBtn1 || !pageBtn2) return;
                // Edge cases: if current is 0 or 1, show 1 and 2
                if(currentZeroBased <= 1){
                    setButton(pageBtn1, 0, currentZeroBased);
                    setButton(pageBtn2, 1, currentZeroBased);
                    return;
                }
                // If near end: per requirement, when current is last or last-1 we want the left two to reset to 1 and 2
                if(typeof totalPages === 'number' && totalPages > 0){
                    const last = totalPages - 1;
                    // if there are only 1 or 2 pages, show them normally
                    if(totalPages <= 2){
                        setButton(pageBtn1, 0, currentZeroBased);
                        setButton(pageBtn2, Math.min(1, last), currentZeroBased);
                        return;
                    }
                    // if current is last or last-1, force left two to be 1 and 2
                    if(currentZeroBased >= last - 1){
                        setButton(pageBtn1, 0, currentZeroBased);
                        setButton(pageBtn2, 1, currentZeroBased);
                        return;
                    }
                }
                // general case: button2 is current, button1 is previous
                setButton(pageBtn1, currentZeroBased - 1, currentZeroBased);
                setButton(pageBtn2, currentZeroBased, currentZeroBased);
            }

            // initialize on load
            try{
                const cur = parseInt(pageInput.value || '0', 10);
                updateFirstTwoButtons(cur);
            }catch(e){/* ignore */}
        })();
    </script>
</body>
</html>